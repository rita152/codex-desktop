# Backend Rust Coding Standards

本规范用于指导本项目后端 Rust 代码的编写与重构，目标是减少返工、提升可维护性，并确保行为一致与可测试性。

## 1) 目标

- 可维护性：清晰的模块边界、可读性优先的代码组织。
- 可靠性：强类型、显式错误处理、可复现的行为。
- 性能：避免不必要的分配与阻塞，关注关键路径。
- 安全：避免未验证输入、数据泄露和脆弱的默认配置。
- 可测试性：单元测试与集成测试覆盖关键逻辑与边界条件。

## 2) 适用范围

适用于后端 Rust 代码（包括但不限于 `src-tauri/` 及其子 crate）。
若新增后端 crate，应确保同样遵循本规范。

## 3) 工具链与基线要求

- Rust 版本：明确 MSRV（Minimum Supported Rust Version），并在文档中注明。
- Edition：使用稳定版 Rust Edition（如 2021 或更新）。
- 代码格式：必须通过 `rustfmt`（使用默认或团队统一配置）。
- Lint：必须通过 `clippy`（启用 `-D warnings` 或相同严格度）。
- CI：在 CI 中强制执行 `fmt`、`clippy`、`test`。

推荐命令：
- `cargo fmt --all -- --check`
- `cargo clippy --all-targets --all-features -- -D warnings`
- `cargo test --all`

## 4) 项目结构与模块组织

- 每个 crate 只做一类职责，避免“万能 crate”。
- 模块层级不宜过深，通常不超过 3-4 层。
- 文件组织遵循 Rust 约定：`mod.rs` 或同名文件夹，不混用。
- 公共 API 放在 `lib.rs` 或 `mod.rs` 顶层集中导出。

推荐目录示例（可按需调整）：

```
src-tauri/
  src/
    main.rs
    lib.rs
    api/
    domain/
    infra/
    utils/
```

## 5) 命名规范

- 模块、函数、变量：`snake_case`
- 类型、trait、enum：`CamelCase`
- 常量：`SCREAMING_SNAKE_CASE`
- trait 方法遵循语义命名，避免 `do_*` 等模糊前缀。

## 6) 可见性与 API 设计

- 默认使用私有可见性；仅暴露必要接口。
- 对外接口应提供清晰文档与示例。
- 避免过度暴露内部细节，如私有结构体字段。

## 7) 错误处理

- 禁止在业务逻辑中使用 `unwrap()`/`expect()`。
- 使用 `Result<T, E>` 进行显式错误处理，优先 `?` 传播。
- 错误类型定义：
  - 公共 API 使用具体错误类型（例如 `thiserror`）。
  - 应用层可使用 `anyhow` 进行上下文增强。
- 错误信息应包含可诊断的上下文，不泄露敏感数据。

示例：

```rust
use thiserror::Error;

#[derive(Debug, Error)]
pub enum UserError {
    #[error("user not found: id={0}")]
    NotFound(String),
}
```

## 8) 日志与可观测性

- 使用 `tracing` 作为统一日志框架。
- 日志分级明确：`trace`/`debug`/`info`/`warn`/`error`。
- 不能记录敏感数据（密钥、口令、个人隐私信息）。
- 关键流程需记录可追踪字段（request_id、session_id 等）。

## 9) 并发与异步

- 同步与异步边界清晰，不在异步上下文中调用阻塞函数。
- 使用 async runtime（如 `tokio`）时，阻塞任务应放入专用线程池。
- 避免共享可变状态，优先使用不可变数据与消息传递。
- 使用锁时必须注明锁粒度与临界区范围，避免死锁。

## 10) 数据与内存管理

- 避免不必要的 clone；优先使用引用与借用。
- 数据结构选择以可读性与复杂度权衡，避免过早优化。
- 对关键路径的分配/拷贝行为进行注释或基准测试说明。

## 11) 安全规范

- 所有外部输入必须进行验证（长度、格式、范围）。
- 禁止拼接未过滤的命令或路径。
- 处理文件与路径需防止路径遍历（`../`）。
- 明确区分可信与不可信数据源。

## 12) 配置与环境

- 配置项必须有明确默认值与来源说明。
- 禁止硬编码机密数据。
- 对关键配置（例如路径、网络地址）应验证可用性并给出明确错误。

## 13) 测试规范

- 单元测试覆盖核心逻辑与边界条件。
- 集成测试覆盖跨模块与系统交互路径。
- 测试用例命名表达行为与场景（`should_*` 风格）。
- 为复杂逻辑提供至少一个失败路径测试。

## 14) 文档与注释

- 公共 API 必须提供 rustdoc 文档。
- 非显而易见的算法或业务规则必须注释说明。
- 避免无意义注释（如“赋值变量”）。

## 15) 性能与质量

- 对关键热点函数进行基准测试或注释说明。
- 关注 `clippy` 建议中与性能相关的 lint。
- 避免在循环内进行昂贵的动态分配。

## 16) 变更检查清单

合并前必须确认：

- `cargo fmt` 无格式问题。
- `cargo clippy` 无警告（或已充分解释）。
- `cargo test` 全部通过。
- 新增逻辑包含对应测试。
- 新增公共 API 有 rustdoc 文档。

## 17) 规范维护

- 本文档为后端 Rust 统一规范来源，若需要新增规则，应先在此处记录并说明理由。
- 一旦形成新模式（例如错误处理、配置加载方式），必须同步更新本规范。
